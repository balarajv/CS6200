import gensim
from collections import defaultdict
from collections import OrderedDict
from ElasticSearchHelper import *
from gensim.parsing.preprocessing import STOPWORDS
import os
import numpy as np
import string
import pickle
from sklearn import cluster
import numpy

class LDA_all_docs(object):
    """docstring for LDA_all_docs"""
    def __init__(self):
        self.es = ES()
        
    def get_texts(self):
        texts = self.es.get_all_documents()
        all_text = []
        remove_punctuation_map = dict((ord(char), None) for char in string.punctuation)
        for text in texts:
            all_text.append(self.tokenize(text, remove_punctuation_map))
        return all_text

    def tokenize(self, text, remove_punctuation_map):
        l_text = text.lower().translate(remove_punctuation_map)
        return [token for token in l_text.strip().split() if token not in STOPWORDS]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    

    def get_dictionary(self, again, texts):
            if not again and os.path.isfile("part2_dictionary.dict"):
                dictionary = gensim.corpora.Dictionary.load(
                    "part2_dictionary.dict")
                return dictionary
        
            dictionary = gensim.corpora.Dictionary(texts)
            dictionary.filter_extremes(no_below=10, no_above=0.6)
            dictionary.save("part2_dictionary.dict")
            return dictionary

    def get_corpus(self, again, texts, dictionary):
        if not again and os.path.isfile("part2_corpus.mm"):
            corpus = gensim.corpora.MmCorpus("part2_corpus.mm")
            return corpus
        corpus = [dictionary.doc2bow(text) for text in texts]
        gensim.corpora.MmCorpus.serialize("part2_corpus.mm", corpus)
        return corpus

    def do_lda(self, again = False):
        texts = []
        if (again or
            (not os.path.isfile("part2_dictionary.dict") and
            not os.path.isfile("part2_corpus.mm"))):
            texts = self.get_texts()

        dictionary = self.get_dictionary(again, texts)
        corpus = self.get_corpus(again ,texts, dictionary)

        model = gensim.models.LdaModel(corpus=corpus, id2word=dictionary, num_topics=200, passes=5, alpha='auto', minimum_probability = 0)
        model.save("lda_part2.model")
        return model

    def get_topics_for_documents(self, dictionary, lda_model):
        all_docs   = self.es.get_all_documents_dict()
        doc_topics = {}
        doc_topic_vector = {}
        i = 0
        remove_punctuation_map = dict((ord(char), None) for char in string.punctuation)
        for doc in all_docs:
            i =i +1
            print i
            bow_vector = dictionary.doc2bow(self.tokenize(all_docs[doc], remove_punctuation_map))
            doc_topic_vector[doc] = lda_model[bow_vector]
            if(i % 10000 == 0):
                with open('doc_topic_vector_new'+str(i)+'.pkl', 'wb') as output:
                            pickle.dump(doc_topic_vector, output, pickle.HIGHEST_PROTOCOL)
                            doc_topic_vector = {}

                
        return doc_topic_vector

    def read_doc_topic_vector(self, index):
        with open('doc_topic_vector_new'+str(index)+'.pkl', 'rb') as input:
            doc_topic_vector = pickle.load(input)
            return doc_topic_vector

    def fetch_reamianing_doc_topics(self, dictionary, lda_model):
        all_docs   = self.es.get_all_documents_dict()
        doc_topics = {}
        all_doc_topic_vector = {}
        doc_topic_vector = {}
        remove_punctuation_map = dict((ord(char), None) for char in string.punctuation)
        for i in range(1, 8, 1):
            all_doc_topic_vector.update(self.read_doc_topic_vector(i*10000))
        i = 0
        for doc in all_docs:
            i += 1
            print i
            if doc not in all_doc_topic_vector:
                bow_vector = dictionary.doc2bow(self.tokenize(all_docs[doc], remove_punctuation_map))
                doc_topic_vector[doc] = lda_model[bow_vector]

        all_doc_topic_vector.update(doc_topic_vector)
        with open('doc_topic_vector_remaining.pkl', 'wb') as output:
            pickle.dump(doc_topic_vector, output, pickle.HIGHEST_PROTOCOL)
            doc_topic_vector = {}
        return all_doc_topic_vector

    def club_all_docs(self):
        all_doc_topic_vector = {}
        for i in range(1, 8, 1):
            all_doc_topic_vector.update(self.read_doc_topic_vector(i*10000))
        
        with open('doc_topic_vector_remaining.pkl', 'rb') as input:
            all_doc_topic_vector.update(pickle.load(input))

        return all_doc_topic_vector

    def load_LDA(self):
        return gensim.models.LdaModel.load("lda_part2.model")

    def compute_kmeans_clustering(self, doc_topic_vector):
        matrix = self.get_feature_matrix(doc_topic_vector)
        kmeans = cluster.KMeans(n_clusters=25, precompute_distances = True)
        kmeans.fit(matrix)
        print kmeans.labels_

        with open('kmeans.model', 'wb') as output:
                    pickle.dump(kmeans, output, pickle.HIGHEST_PROTOCOL)


    def get_confusion_matrix(self, labels):
        with open("query_desc.short.txt") as input:
            lines = input.readlines()
        queries = []
        for line in lines:
            queries.append(line.strip().split()[0])

        with open("qrels.adhoc.51-100.AP89.txt") as input:
            lines = input.readlines()
        relevant_docs = []
        for line in lines:
            query_id, _, doc_id, label = line.strip().split()
            if label == "1" and query_id in queries:
                relevant_docs.append([query_id, doc_id])
        print len(relevant_docs)
        all_labels = self.construct_labels(labels)
        pair_relevant_docs = []
        for i in range(0, len(relevant_docs), 1):
            for j in range(i+1, len(relevant_docs), 1):
                pair_relevant_docs.append(relevant_docs[i] + relevant_docs[j])
        confusion_matrix = []
        same_query_same_cluster = 0
        same_query_different_cluster = 0
        different_query_different_cluster = 0
        different_query_same_cluster = 0

        for pair in pair_relevant_docs:
            if(pair[0] == pair[2] and all_labels[pair[1]] == all_labels[pair[3]]):
                same_query_same_cluster += 1
                confusion_matrix.append([1,0,0,0])
            elif(pair[0] != pair[2] and all_labels[pair[1]] == all_labels[pair[3]]):
                same_query_different_cluster += 1
                confusion_matrix.append([0,0,1,0])
            elif(pair[0] == pair[2] and all_labels[pair[1]] != all_labels[pair[3]]):
                different_query_same_cluster += 1
                confusion_matrix.append([0,0,1,0])
            elif(pair[0] != pair[2] and all_labels[pair[1]] != all_labels[pair[3]]):
                different_query_different_cluster += 1
                confusion_matrix.append([0,0,0,1])

        print "same_query_same_cluster "+str(same_query_same_cluster)
        print "same_query_different_cluster "+str(same_query_different_cluster)
        print "different_query_same_cluster "+str(different_query_same_cluster)
        print "different_query_different_cluster "+str(different_query_different_cluster)
        
        self.print_percentage_accuracy(confusion_matrix)
        return confusion_matrix

    def construct_labels(self, labels):
        doc_ids_order = self.es.get_doc_ids_in_order()
        i = 0
        all_labels = {}
        for doc_id in doc_ids_order:
            all_labels[doc_id] = labels[i]
            i += 1
        return all_labels

    def print_percentage_accuracy(self, confusion_matrix):
        accurate = 0
        for element in confusion_matrix:
            if element[0] == 1 or element[3] == 1:
                accurate += 1
        print float(accurate)/len(confusion_matrix )

    def get_feature_matrix(self, doc_topic_vector):
        rows = len(doc_topic_vector)
        columns = 200
        matrix_x  = numpy.zeros(shape=(rows,columns))
        no_row = 0
        doc_ids_order = self.es.get_doc_ids_in_order()
        for doc_id in doc_ids_order:
            row = []
            for feature in doc_topic_vector[doc_id]:
                row.append(feature[1])
            matrix_x[no_row] = row
            no_row+= 1
        return matrix_x


 
if __name__ == '__main__':
    
    with open('kmeans.model', 'rb') as input:
        kmeans = pickle.load(input)
    #print kmeans.labels_[0]
    #print len(kmeans.labels_)
    part2 = LDA_all_docs()
    part2.get_confusion_matrix(kmeans.labels_)

    
    """
    part2 = LDA_all_docs()
    #part2.do_lda()
    dictionary = gensim.corpora.Dictionary.load("part2_dictionary.dict")
    lda_model = part2.load_LDA()
    #part2.get_topics_for_documents(dictionary, lda_model)
    #doc_topic_vector = part2.fetch_reamianing_doc_topics(dictionary, lda_model)
    all_doc_topic_vector = part2.club_all_docs()
    part2.compute_kmeans_clustering(all_doc_topic_vector)

    #with open('doc_topic_vector.pkl', 'rb') as input:
    #    doc_topic_vector = pickle.load(input)
    #print "done"
    #print len(doc_topic_vector)
    #print doc_topic_vector["AP890101-0040"]

    #for i in lda_model.print_topics(200):
    #    print i
    """
